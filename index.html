<!DOCTYPE html>
<html>

<head>
  <title>Mapa Interactivo</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- === Estilos de Leaflet y Leaflet.Draw === -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <style>
    #map { height: 950px; }
    .menu {
      position: fixed;
      top: 1vh;
      left: 1vw;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.85);
      padding: 0.5em;
      border-radius: 5px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    select, button { padding: 5px; font-size: 12px; }
    .leaflet-draw.leaflet-control { margin-top: 5vh !important; }
    .etiqueta-poligono {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 100px;
      padding: 1px 5px;
      font-weight: 500;
      font-size: 15px;
      color: #060606;
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.15);
      pointer-events: none;
      white-space: nowrap;
    }
    .menu-contextual {
      background: white;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      font-size: 14px;
    }
    .menu-contextual button {
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      display: block;
      margin: 5px 0;
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="menu">
    <select id="selectorTerritorios" onchange="cambiarTerritorio(); this.blur();">
      <option value="">-- Selecciona un territorio --</option>
      <option value="areaGrande">√Årea Grande</option>
      <option value="territorio1">Territorio 1</option>
      <option value="territorio2">Territorio 2</option>
    </select>
  </div>

  <div id="map"></div>

  <div id="menuContextual" class="menu-contextual" style="display:none; position:absolute; z-index:2000;"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <script>
    var map = L.map("map", { maxZoom: 22, zoomControl: false }).setView([28.596, -106.0750], 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OpenStreetMap", maxZoom: 22 }).addTo(map);

    var poligonos = []; // array general de pol√≠gonos
    var etiquetasActivas = []; // markers visibles
    var notasPoligonos = {};  // notas

    // Funciones para notas
    function anadirNota(id) {
      var nuevaNota = prompt("Escribe tu nota:");
      if (nuevaNota) {
        if (!notasPoligonos[id]) notasPoligonos[id] = [];
        notasPoligonos[id].push(nuevaNota);
        alert("‚úÖ Nota guardada!");
      }
      ocultarMenu();
    }

    function verNotas(id) {
      var listaNotas = notasPoligonos[id] || [];
      if (listaNotas.length === 0) { alert("üì≠ No hay notas todav√≠a."); ocultarMenu(); return; }
      var notasTexto = listaNotas.map((n,i)=>`${i+1}. ${n}`).join("\n\n");
      var editar = confirm("üìí Notas:\n\n"+notasTexto+"\n\n¬øQuieres editar las notas?");
      if (editar) {
        var nuevasNotas = prompt("Edita las notas (separa por salto de l√≠nea):", listaNotas.join("\n"));
        if (nuevasNotas !== null) notasPoligonos[id] = nuevasNotas.split("\n").filter(n=>n.trim()!=="");
        alert("‚úèÔ∏è Notas actualizadas!");
      }
      ocultarMenu();
    }

    function mostrarMenu(e, id, lat, lng) {
      var menu = document.getElementById("menuContextual");
      var x = e.originalEvent.clientX || (e.originalEvent.touches && e.originalEvent.touches[0].clientX);
      var y = e.originalEvent.clientY || (e.originalEvent.touches && e.originalEvent.touches[0].clientY);
      menu.style.left = x + "px"; menu.style.top = y + "px"; menu.style.display = "block";
      menu.innerHTML = `
        <button onclick="window.open('https://www.google.com/maps?q=${lat},${lng}','_blank'); ocultarMenu();">üìç Ubicaci√≥n</button>
        <button onclick="anadirNota('${id}')">‚ûï A√±adir nota</button>
        <button onclick="verNotas('${id}')">üìí Notas</button>
      `;
    }

    function ocultarMenu() { document.getElementById("menuContextual").style.display="none"; }
    map.on("click", ocultarMenu);

    // Funci√≥n para mostrar etiquetas solo al seleccionar
    function mostrarEtiquetas(territorio) {
      etiquetasActivas.forEach(m => map.removeLayer(m));
      etiquetasActivas = [];
      territorio.eachLayer(function(pol) {
        if (pol._label) {
          let latlngs = pol.getLatLngs()[0];
          let coords = latlngs.map(ll=>[ll.lng,ll.lat]);
          coords.push([coords[0][0],coords[0][1]]);
          let centroide = turf.centroid(turf.polygon([coords]));
          let cLat = centroide.geometry.coordinates[1];
          let cLng = centroide.geometry.coordinates[0];
          let marker = L.marker([cLat,cLng], {
            icon: L.divIcon({ className:"etiqueta-poligono", html:pol._label, iconSize:[10,18], iconAnchor:[20,9] })
          }).addTo(map);
          etiquetasActivas.push(marker);
        }
      });
    }

    // Funci√≥n para seleccionar territorio
    function cambiarTerritorio() {
      var selector = document.getElementById("selectorTerritorios");
      var valor = selector.value;
      selector.blur(); // cerrar men√∫ en m√≥vil

      // ocultar todas etiquetas
      etiquetasActivas.forEach(m => map.removeLayer(m));
      etiquetasActivas = [];

      if (valor === "areaGrande") {
        if (typeof areaGrande !== "undefined" && areaGrande) map.fitBounds(areaGrande.getBounds());
      } else if (valor === "territorio1") {
        if (typeof territorio1 !== "undefined" && territorio1) {
          map.fitBounds(territorio1.getBounds());
          mostrarEtiquetas(territorio1);
        }
      } else if (valor === "territorio2") {
        if (typeof territorio2 !== "undefined" && territorio2) {
          map.fitBounds(territorio2.getBounds());
          mostrarEtiquetas(territorio2);
        }
      }
    }
  </script>

  <!-- Archivos externos de territorios y dibujo -->
  <script src="area_grande.js"></script>
  <script src="territoriobase.js"></script>
  <script src="territorio1.js"></script>
  <script src="dibujo.js"></script>
</body>
</html>

