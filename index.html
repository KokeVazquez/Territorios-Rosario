<!DOCTYPE html>
<html>


<head>
  <title>Territorio Rosario</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Logo de la p√°gina -->
  <link rel="icon" href="https://KokeVazquez.github.io/Territorios-Rosario/logo.png" type="image/png">

  <!-- Estilos de Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <!-- Tarjeta al compartir link en WhatsApp -->
  <meta property="og:title" content="Mapa Rosario ‚Äî Territorios">
  <meta property="og:description" content="Mapa interactivo con territorios y funciones para trabajo de campo.">
  <meta property="og:image" content="https://i.imgur.com/HlPcpSB.png">
  <meta property="og:url" content="https://KokeVazquez.github.io/Territorios-Rosario/?v=3">
  <meta property="og:type" content="website">
</head>

<style>
  /* ===========================
   === Base / Reset =========
   =========================== */
  html,
  body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
  }

  /* ===========================
   === Mapa =================
   =========================== */
  #map {
    height: 100vh;
    width: 100vw;
    margin: 0;
    padding: 0;
  }

  /* =====================================
   === Men√∫ izquierdo (selector) =======
   ===================================== */
  .menu {
    position: fixed;
    top: 1vh;
    left: 1vw;
    z-index: 1000;
    background: rgba(0, 0, 0, 0);
    padding: 0.5em;
    border-radius: 8px;
  }

  /* =====================================
   === Men√∫ derecho (√Årea Grande + Notas)
   ===================================== */
  .menu-derecha {
    position: fixed;
    top: 1%;
    right: 1%;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 2vh;
    /* separaci√≥n entre botones para escritorio */
    margin: 0;
    padding: 0;
  }

  /* === Estilos para los botones dentro de menu-derecha === */
  .menu-derecha button {
    padding: 1vh 2vw;
    font-size: 1.8vh;
    border-radius: 5px;
    cursor: pointer;
  }

  /* =================================================
   === Selector de meses debajo del bot√≥n Notas ===
   === (est√©tica igual a selectorTerritorios) ======
   ================================================= */
  #filtroMes {
    padding: 1.0vh 1vw;
    font-size: 0.8vw;
    font-weight: bold;
    border: 2px solid #000;
    outline: none;
    border-radius: 20px;
    background-color: #fff;
    color: #000;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    transition: all 0.25s ease-in-out;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent;
    margin-top: 0.5vh;
    /* peque√±o espacio sobre el select */
    background-image: url("data:image/svg+xml;utf8,<svg fill='black' height='24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 1vw center;
    background-size: 16px;
    padding-right: 2vw;
  }

  #filtroMes:hover {
    background-color: #ffffff;
    color: #1f1e1e;
    border-color: #444;
    transform: scale(1.03);
  }

  #filtroMes:active {
    transform: scale(0.97);
    background-color: #222;
    color: #fff;
    border-color: #111;
  }

  /* ===========================
   === Responsivo m√≥vil ======
   =========================== */
  @media (max-width: 480px) {
    .menu-derecha button {
      font-size: 3vw !important;
      padding: 2vh 3vw !important;
      min-width: 100px !important;
    }

    .menu-derecha button {
      font-size: 3vw !important;
      /* aumentar tama√±o del texto en m√≥vil */
      padding: 2vh 2vw !important;
      /* m√°s espacio dentro de los botones */
      min-width: 100px !important;
      /* ancho m√≠nimo para que no se achiquen */
    }

    #selectorTerritorios,
    #filtroMes {
      font-size: 3vw !important;
      padding: 2vh 1vw !important;
      padding-right: 4vw !important;
      background-position: right 3vw center;
    }
  }


  /* ===========================
   === Loader ===============
   =========================== */
  #loader {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  #loader img {
    width: 120px;
    height: auto;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 0.8;
    }

    50% {
      transform: scale(1.1);
      opacity: 1;
    }

    100% {
      transform: scale(1);
      opacity: 0.8;
    }
  }

  /* =================================
   === Botones generales / select ==
   ================================= */
  #selectorTerritorios,
  #btnAreaGrande,
  #btnMostrarTodasNotas {
    padding: 1.0vh 1vw;
    font-size: 0.8vw;
    font-weight: bold;
    border: 2px solid #000;
    outline: none;
    border-radius: 20px;
    background-color: #fff;
    color: #000;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    transition: all 0.25s ease-in-out;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  #selectorTerritorios {
    background-image: url("data:image/svg+xml;utf8,<svg fill='black' height='24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 1vw center;
    background-size: 16px;
    padding-right: 2vw;
  }

  #selectorTerritorios:hover,
  #btnAreaGrande:hover,
  #btnMostrarTodasNotas:hover {
    background-color: #ffffff;
    color: #1f1e1e;
    border-color: #444;
    transform: scale(1.03);
  }

  #selectorTerritorios:active,
  #btnAreaGrande:active,
  #btnMostrarTodasNotas:active {
    transform: scale(0.97);
    background-color: #222;
    color: #fff;
    border-color: #111;
  }

  /* ===========================
   === Otros estilos ========
   =========================== */
  .leaflet-draw.leaflet-control {
    margin-top: 5vh !important;
  }

  .etiqueta-poligono {
    display: inline-block;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50px;
    padding: 2px 10px;
    font-weight: 500;
    font-size: 15px;
    color: black;
    text-align: center;
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.15);
    pointer-events: none;
    white-space: nowrap;
  }

  .menu-contextual {
    background: white;
    padding: 8px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    font-size: 14px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  .menu-contextual button {
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
    display: block;
    margin: 5px 0;
    width: 100%;
  }

  .etiquetaTerritorio {
    background: none;
    border-radius: 50%;
    padding: 5px 1px;
    font-weight: bold;
    font-size: 20px;
    color: black;
    text-align: center;
    pointer-events: none;
    box-shadow: 0 0px 0px black;
  }
</style>








<body>
  <div class="menu">
    <select id="selectorTerritorios" onchange="cambiarTerritorio(); setTimeout(() => this.blur(), 200);">
      <option value="">-- Selecciona un territorio --</option>
      <option value="territorio1">Territorio 1</option>
      <option value="territorio2">Territorio 2</option>
      <option value="territorio3">Territorio 3</option>
      <option value="territorio4">Territorio 4</option>
      <option value="territorio5">Territorio 5</option>
      <option value="territorio6">Territorio 6</option>
      <option value="territorio7">Territorio 7</option>
      <option value="territorio8">Territorio 8</option>
      <option value="territorio9">Territorio 9</option>
      <option value="territorio10">Territorio 10</option>
      <option value="territorio11">Territorio 11</option>
      <option value="territorio12">Territorio 12</option>
      <option value="territorio13">Territorio 13</option>
      <option value="territorio14">Territorio 14</option>
      <option value="territorio15">Territorio 15</option>
      <option value="territorio16">Territorio 16</option>
      <option value="territorio17">Territorio 17</option>
      <option value="territorio18">Territorio 18</option>
      <option value="territorio19">Territorio 19</option>
      <option value="territorio20">Territorio 20</option>
      <option value="territorio21">Territorio 21</option>
      <option value="territorio22">Territorio 22</option>
      <option value="territorio23">Territorio 23</option>
      <option value="territorio24">Territorio 24</option>
      <option value="territorio25">Territorio 25</option>
      <option value="territorio26">Territorio 26</option>
      <option value="territorio27">Territorio 27</option>
      <option value="territorio28">Territorio 28</option>
      <option value="territorio29">Territorio 29</option>
      <option value="territorio30">Territorio 30</option>
      <option value="territorio31">Territorio 31</option>
      <option value="territorio32">Territorio 32</option>
      <option value="territorio33">Territorio 33</option>
      <option value="territorio34">Territorio 34</option>
      <option value="territorio35">Territorio 35</option>
      <option value="territorio36">Territorio 36</option>
      <option value="territorio37">Territorio 37</option>
      <option value="territorio38">Territorio 38</option>
      <option value="territorio39">Territorio 39</option>
      <option value="territorio40">Territorio 40</option>
      <option value="territorio41">Territorio 41</option>
      <option value="territorio42">Territorio 42</option>
      <option value="territorio43">Territorio 43</option>
      <option value="territorio44">Territorio 44</option>
      <option value="territorio45">Territorio 45</option>
      <option value="territorio46">Territorio 46</option>
      <option value="territorio47">Territorio 47</option>
      <option value="territorio48">Territorio 48</option>
      <option value="territorio49">Territorio 49</option>
      <option value="territorio50">Territorio 50</option>
      <option value="territorio51">Territorio 51</option>
      <option value="territorio52">Territorio 52</option>
      <option value="territorio53">Territorio 53</option>
      <option value="territorio54">Territorio 54</option>
      <option value="territorio55">Territorio 55</option>
      <option value="territorio56">Territorio 56</option>
      <option value="territorio57">Territorio 57</option>
      <option value="territorio58">Territorio 58</option>
      <option value="territorio59">Territorio 59</option>
      <option value="territorio60">Territorio 60</option>
      <option value="territorio61">Territorio 61</option>
      <option value="territorio62">Territorio 62</option>
      <option value="territorio63">Territorio 63</option>
      <option value="territorio64">Territorio 64</option>
      <option value="territorio65">Territorio 65</option>
      <option value="territorio66">Territorio 66</option>
      <option value="territorio67">Territorio 67</option>
      <option value="territorio68">Territorio 68</option>
      <option value="territorio69">Territorio 69</option>
      <option value="territorio70">Territorio 70</option>
      <option value="territorio71">Territorio 71</option>
      <option value="territorio72">Territorio 72</option>
      <option value="territorio73">Territorio 73</option>
      <option value="territorio74">Territorio 74</option>
      <option value="territorio75">Territorio 75</option>
      <option value="territorio76">Territorio 76</option>
      <option value="territorio77">Territorio 77</option>
      <option value="territorio78">Territorio 78</option>
      <option value="territorio79">Territorio 79</option>
      <option value="territorio80">Territorio 80</option>
      <option value="territorio81">Territorio 81</option>
      <option value="territorio82">Territorio 82</option>
      <option value="territorio83">Territorio 83</option>
      <option value="territorio84">Territorio 84</option>


    </select>
  </div>

  <div class="menu-derecha">
    <button id="btnAreaGrande">√Årea Grande</button>
    <button id="btnMostrarTodasNotas">Notas</button>
    <button id="btnTerritoriosTerminados">Territorios terminados</button>
    <select id="filtroMes" onchange="filtrarPorMes()">
      <option value="">-- Filtrar por mes --</option>
      <option value="01">Enero</option>
      <option value="02">Febrero</option>
      <option value="03">Marzo</option>
      <option value="04">Abril</option>
      <option value="05">Mayo</option>
      <option value="06">Junio</option>
      <option value="07">Julio</option>
      <option value="08">Agosto</option>
      <option value="09">Septiembre</option>
      <option value="10">Octubre</option>
      <option value="11">Noviembre</option>
      <option value="12">Diciembre</option>
    </select>
  </div>






  <!--BOTON PARA CREAR POLIGONOS-->

  <!-- <button onclick="exportarPoligonos()" style="position: absolute; top: 100px; right: 20px; z-index: 1000;">
    üì§ Exportar
  </button>
-->





  <div id="map"></div>
  <div id="menuContextual" class="menu-contextual" style="display:none; position:absolute; z-index:2000;"></div>
  <div id="loader">
    <img src="JW_Logo.png" alt="Cargando..." />
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>



  <script>





    // ================================
    // === Inicializaci√≥n del mapa ===
    // ================================
    var map = L.map("map", {
      maxZoom: 22,
      zoomControl: false,
      doubleClickZoom: false
    });
    var boundsIniciales = L.latLngBounds([[28.600, -106.075], [28.618, -106.070]]);
    map.fitBounds(boundsIniciales, { padding: [5, 5] });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap",
      maxZoom: 22
    }).addTo(map);






    // ================================
    // === Variables globales ===
    // ================================
    let territorioActivo = null;
    window.todosLosTerritorios = [];
    let etiquetasActivas = [];
    window.indicadoresNotas = [];
    var overlayGris; // Por ahora no funcional, se deja comentado o pendiente






    // ================================
    // === Notas / Capitanes ===
    // ================================
    function anadirNota(pol) {
      let territorioId = pol._territorioId || "territorio";
      let notasGuardadas = JSON.parse(localStorage.getItem(territorioId + "_notas") || "{}");
      let nuevaNota = prompt("Escribe el nombre del capit√°n o nota:", notasGuardadas[pol._id] || "");
      if (nuevaNota !== null) {
        notasGuardadas[pol._id] = nuevaNota;
        localStorage.setItem(territorioId + "_notas", JSON.stringify(notasGuardadas));
        mostrarIndicadoresNotas();
      }
    }

    function mostrarNota(pol) {
      let territorioId = pol._territorioId || "territorio";
      let notasGuardadas = JSON.parse(localStorage.getItem(territorioId + "_notas") || "{}");
      let nota = notasGuardadas[pol._id];
      alert(nota ? "Capit√°n/nota: " + nota : "No hay informaci√≥n registrada.");
    }





    // ================================
    // === Bot√≥n Mostrar Todas Notas (Toggle) ===
    // ================================
    let notasMostradas = false;

    document.getElementById("btnMostrarTodasNotas").addEventListener("click", function () {
      if (!notasMostradas) {
        // Recorrer todos los territorios
        window.todosLosTerritorios.forEach(territorio => {
          const notasTerritorio = JSON.parse(localStorage.getItem(territorio._id + "_notas") || "{}");
          // Recorrer todos los pol√≠gonos del territorio
          territorio.eachLayer(function (pol) {
            if (notasTerritorio[pol._id] && notasTerritorio[pol._id].length > 0) {
              // Obtener centroide del pol√≠gono
              const latlngs = pol.getLatLngs()[0];
              const coords = latlngs.map(ll => [ll.lng, ll.lat]);
              coords.push([coords[0][0], coords[0][1]]); // cerrar el pol√≠gono
              const centroide = turf.centroid(turf.polygon([coords]));
              const cLat = centroide.geometry.coordinates[1];
              const cLng = centroide.geometry.coordinates[0];
              // Crear marcador de nota
              const marker = L.marker([cLat, cLng], {
                interactive: false,
                icon: L.divIcon({
                  className: "indicador-nota",
                  html: "üìí",
                  iconSize: [20, 20],
                  iconAnchor: [10, 10]
                })
              }).addTo(map);
              // Guardarlo para poder eliminarlo despu√©s
              window.indicadoresNotas.push(marker);
            }
          });
        });
        notasMostradas = true;
      } else {
        // Quitar todos los √≠conos de notas
        window.indicadoresNotas.forEach(m => map.removeLayer(m));
        window.indicadoresNotas = [];
        notasMostradas = false;
      }
    });





    // ================================
    // === Notas / Capitanes / Fecha ===
    // ================================
    function registrarCapitan(pol) {
      const territorioId = pol._territorioId || "territorio";
      // Obtener datos existentes
      let registros = JSON.parse(localStorage.getItem(territorioId + "_capitanes") || "{}");

      // Pedir nombre del capit√°n
      let capitan = prompt("Nombre del capit√°n:");
      if (!capitan) return;

      // Pedir fecha (YYYY-MM-DD)
      let fecha = prompt("Fecha de trabajo (YYYY-MM-DD):");
      if (!fecha) return;

      if (!registros[pol._id]) registros[pol._id] = [];
      registros[pol._id].push(`Capit√°n: ${capitan} | Fecha: ${fecha}`);

      localStorage.setItem(territorioId + "_capitanes", JSON.stringify(registros));

      // Pintar de gris
      pol._selected = true;
      pol.setStyle({ color: "gray", fillColor: "gray", fillOpacity: 0.9 });

      // Mostrar icono de palomita
      const latlngs = pol.getLatLngs()[0];
      const coords = latlngs.map(ll => [ll.lng, ll.lat]);
      coords.push([coords[0][0], coords[0][1]]);
      const centroide = turf.centroid(turf.polygon([coords]));
      const cLat = centroide.geometry.coordinates[1];
      const cLng = centroide.geometry.coordinates[0];

      const marker = L.marker([cLat, cLng], {
        interactive: false,
        icon: L.divIcon({
          className: "indicador-nota",
          html: "‚úÖ",
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        })
      }).addTo(map);

      window.indicadoresNotas.push(marker);
    }
    // Mostrar todos los iconos de palomita seg√∫n mes
    function filtrarPorMes() {
      const mes = document.getElementById('filtroMes').value;
      // Limpiar iconos anteriores
      window.indicadoresNotas.forEach(m => map.removeLayer(m));
      window.indicadoresNotas = [];
      window.todosLosTerritorios.forEach(territorio => {
        const registros = JSON.parse(localStorage.getItem(territorio._id + "_capitanes") || "{}");
        territorio.eachLayer(pol => {
          let trabajadoEsteMes = false;
          (registros[pol._id] || []).forEach(reg => {
            const fecha = reg.split('| Fecha:')[1]?.trim();
            if (fecha && fecha.slice(5, 7) === mes) trabajadoEsteMes = true;
          });
          if (trabajadoEsteMes) {
            pol._selected = true;
            pol.setStyle({ color: "gray", fillColor: "gray", fillOpacity: 0.9 });
            // Crear icono de palomita
            const latlngs = pol.getLatLngs()[0];
            const coords = latlngs.map(ll => [ll.lng, ll.lat]);
            coords.push([coords[0][0], coords[0][1]]);
            const centroide = turf.centroid(turf.polygon([coords]));
            const cLat = centroide.geometry.coordinates[1];
            const cLng = centroide.geometry.coordinates[0];
            const marker = L.marker([cLat, cLng], {
              interactive: false,
              icon: L.divIcon({
                className: "indicador-nota",
                html: "‚úÖ",
                iconSize: [20, 20],
                iconAnchor: [10, 10]
              })
            }).addTo(map);
            window.indicadoresNotas.push(marker);
          } else {
            pol._selected = false;
            pol.setStyle(pol._originalStyle);
          }
        });
      });
    }






// ========================================================================================
// === Bot√≥n Territorios Terminados ===
// ========================================================================================
document.getElementById("btnTerritoriosTerminados").addEventListener("click", function () {
  const mes = document.getElementById('filtroMes').value;
  if (!mes) {
    alert("Selecciona primero un mes para mostrar los territorios terminados.");
    return;
  }
  let mesNombre = new Date(2025, parseInt(mes) - 1).toLocaleString('es-MX', { month: 'long' });

  // Funci√≥n para generar el HTML de los registros
function generarHtml() {
  let html = `
    <h2 style="text-align:center; color:#333;">üó∫Ô∏è Territorios terminados - ${mesNombre}</h2>
    <hr style="margin-bottom:15px;">
  `;
  let hayRegistros = false;
  const mesesCortos = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
  window.todosLosTerritorios.forEach((territorio, tIndex) => {
    let territorioHtml = "";
    territorio.eachLayer(pol => {
      if (!pol._selected) return;
      const registros = JSON.parse(localStorage.getItem(territorio._id + "_capitanes") || "{}");
      (registros[pol._id] || []).forEach(reg => {
        const partes = reg.split('| Fecha:');
        const capitan = partes[0].replace("Capit√°n:", "").replace("Trabajado por:", "").trim();
        const fecha = partes[1]?.trim();
        if (!fecha) return;
        let mesRegistro = '';
        if (fecha.includes('-')) mesRegistro = fecha.split('-')[1];
        else if (fecha.includes('/')) mesRegistro = fecha.split('/')[1];
        else if (fecha.length >= 5) mesRegistro = fecha.slice(3, 5);
        if (mesRegistro === mes.padStart(2, '0')) {
          if (!territorioHtml)
            territorioHtml += `<h3 style="margin-top:15px; color:#444;">üìç Territorio ${tIndex + 1}</h3>`;
          // --- Limpiar nombre de cuadra ---
          const cuadraLimpia = pol._id.replace(/^.*?Cuadra(\d+).*$/i, "$1").trim(); // saca solo el n√∫mero
          // --- Convertir fecha a formato 04-oct-25 ---
          let partesFecha = fecha.split("-");
          let dia = partesFecha[0].padStart(2, "0");
          let mesNum = parseInt(partesFecha[1], 10);
          let anio = partesFecha[2];
          let mesTexto = mesesCortos[mesNum - 1] || "???";
          let fechaFormateada = `${dia}-${mesTexto}-${anio}`;
          // --- HTML del registro ---
          territorioHtml += `
            <p class="registroItem" style="background:#f8f8f8; padding:8px 10px; border-radius:6px; margin:5px 0; position:relative; color:#000;">
              <strong>Cuadra ${cuadraLimpia}</strong> |
              Trabajado por: <strong style="color:red;">${capitan}</strong> |
              Fecha: <strong style="color:red;">${fechaFormateada}</strong>
            </p>
          `;
        }
      });
    });
    if (territorioHtml) {
      html += territorioHtml;
      hayRegistros = true;
    }
  });
  if (!hayRegistros) html += "<p>No se encontraron registros para este mes.</p>";
  html += `
    <button id="borrarRegistros" 
      style="display:block; margin:20px auto 0; padding:12px 18px; background:#e53935; color:white; border:none; 
      border-radius:8px; font-size:16px; cursor:pointer; transition:transform 0.1s;">
      üóëÔ∏è Borrar registros del mes
    </button>
  `;
  return html;
}



  // Crear popup tipo modal
  const modal = document.createElement("div");
  modal.style.position = "fixed";
  modal.style.top = 0;
  modal.style.left = 0;
  modal.style.width = "100%";
  modal.style.height = "100%";
  modal.style.backgroundColor = "rgba(0,0,0,0.6)";
  modal.style.zIndex = 9999;
  modal.style.overflowY = "auto";
  modal.style.backdropFilter = "blur(3px)";

  modal.innerHTML = `
    <div id="contenidoModal" 
      style="background:#fff; padding:25px; margin:60px auto; width:85%; max-width:750px; 
      border-radius:12px; position:relative; box-shadow:0 5px 20px rgba(0,0,0,0.3); transition: all 0.3s ease;">
      
      <button id="cerrarModal" 
        style="position:absolute; top:10px; right:10px; font-size:20px; background:none; border:none; cursor:pointer;">‚úñ</button>
      
      ${generarHtml()}
    </div>
  `;
  document.body.appendChild(modal);

  const contenidoModal = document.getElementById("contenidoModal");

  // Cerrar popup
  document.getElementById("cerrarModal").addEventListener("click", () => {
    document.body.removeChild(modal);
  });

  // Funci√≥n para animar y borrar registros
  function borrarRegistrosDelMes() {
    const btnBasura = document.getElementById("borrarRegistros");

    // Animaci√≥n de vibraci√≥n
    btnBasura.style.transform = "translateX(5px)";
    setTimeout(() => btnBasura.style.transform = "translateX(-5px)", 50);
    setTimeout(() => btnBasura.style.transform = "translateX(0px)", 100);

    // Borrar registros en localStorage
    window.todosLosTerritorios.forEach(territorio => {
      const registros = JSON.parse(localStorage.getItem(territorio._id + "_capitanes") || "{}");
      Object.keys(registros).forEach(polId => {
        registros[polId] = registros[polId].filter(reg => {
          const fecha = reg.split('| Fecha:')[1]?.trim() || '';
          let mesRegistro = '';
          if (fecha.includes('-')) mesRegistro = fecha.split('-')[1];
          else if (fecha.includes('/')) mesRegistro = fecha.split('/')[1];
          else if (fecha.length >= 5) mesRegistro = fecha.slice(3, 5);
          return mesRegistro !== mes.padStart(2, '0');
        });
      });
      localStorage.setItem(territorio._id + "_capitanes", JSON.stringify(registros));
    });

    // Resetear estilos de los pol√≠gonos
    window.todosLosTerritorios.forEach(territorio => {
      territorio.eachLayer(pol => {
        if (pol._selected) {
          pol._selected = false;
          pol.setStyle(pol._originalStyle);
        }
      });
    });

    filtrarPorMes(); // refrescar el mapa

    // Animaci√≥n de franja blanca sobre cada registro
    const registrosItems = contenidoModal.querySelectorAll(".registroItem");
    registrosItems.forEach(item => {
      const overlay = document.createElement("div");
      overlay.style.cssText = `
        position:absolute; top:0; left:-100%; width:100%; height:100%; 
        background:white; transition:left 0.5s ease; z-index:5;
      `;
      item.appendChild(overlay);
      void overlay.offsetHeight; // fuerza reflow (importante para PC)
      setTimeout(() => overlay.style.left = "0%", 10);
    });

    // Limpiar despu√©s de la animaci√≥n
    setTimeout(() => {
      contenidoModal.innerHTML = `
        <button id="cerrarModal" 
          style="position:absolute; top:10px; right:10px; font-size:20px; background:none; border:none; cursor:pointer;">‚úñ</button>
        <h2 style="text-align:center;">‚úÖ Registros del mes eliminados</h2>
      `;
      document.getElementById("cerrarModal").addEventListener("click", () => {
        document.body.removeChild(modal);
      });
    }, 700);
  }

  // Asignar evento al bot√≥n de borrar
  document.getElementById("borrarRegistros").addEventListener("click", borrarRegistrosDelMes);
});






















    // ================================
    // === Men√∫ contextual ===
    // ================================
    function ocultarMenu() {
      const menu = document.getElementById("menuContextual");
      if (menu) menu.style.display = "none";
    }
    function mostrarMenu(e, pol) {
      ocultarMenu();
      const menu = document.getElementById("menuContextual");
      if (!menu) return;
      var x = e.originalEvent.clientX || (e.originalEvent.touches && e.originalEvent.touches[0].clientX);
      var y = e.originalEvent.clientY || (e.originalEvent.touches && e.originalEvent.touches[0].clientY);
      menu.style.left = x + "px";
      menu.style.top = y + "px";
      menu.style.display = "block";
      menu.innerHTML = `
      <button onclick="window.open('${pol._link}', '_blank'); ocultarMenu();">üìç Ubicaci√≥n</button>
      <button onclick="anadirNota(pol); ocultarMenu();">‚ûï A√±adir nota</button>
      <button onclick="mostrarNota(pol); ocultarMenu();">üìí Notas</button>
    `;
    }
    map.on("click", ocultarMenu);






    // ================================
    // === Loader ===
    // ================================
    function mostrarLoader() {
      const loader = document.getElementById("loader");
      if (loader) loader.style.display = "flex";
    }
    function ocultarLoader() {
      const loader = document.getElementById("loader");
      if (loader) loader.style.display = "none";
    }
    function flyWithLoader(bounds, callback) {
      mostrarLoader();
      map.flyToBounds(bounds, { padding: [20, 20] });
      map.once('moveend', function () {
        ocultarLoader();
        if (callback) callback();
      });
    }






    // ================================
    // === Enfocar un territorio ===
    // ================================
    function enfocarTerritorio(grupo) {
      territorioActivo = grupo;
      // Desactivar interacci√≥n de todos los territorios
      window.todosLosTerritorios.forEach(t => {
        t.eachLayer(pol => {
          pol.off('click');
          pol.off('contextmenu');
          pol.setStyle(pol._originalStyle);
        });
      });
      // Activar interacci√≥n solo en el territorio activo
      territorioActivo.eachLayer(pol => {
        pol._territorioId = grupo._id || "territorio";
        // Restaurar estilo seg√∫n estado guardado
        pol.setStyle(pol._selected ? { color: "gray", fillColor: "gray", fillOpacity: 0.9 } : pol._originalStyle);
        // Registrar eventos
        pol.off('click');
        pol.off('contextmenu');
        pol.on('click', function () {
          pol._selected = !pol._selected;
          pol.setStyle(pol._selected ? { color: "gray", fillColor: "gray", fillOpacity: 0.9 } : pol._originalStyle);


          //-----------------------------ESTO ES LO QUE CAUSABA QUE LOS POLIGONOS SE QUEDARAN SIEMPRE EN GRIS----------------------------------//
          // // const estadoGuardado = JSON.parse(localStorage.getItem(pol._territorioId + "_estado") || "{}");
          //estadoGuardado[pol._id] = pol._selected;
          //localStorage.setItem(pol._territorioId + "_estado", JSON.stringify(estadoGuardado));
          //-----------------------------ESTO ES LO QUE CAUSABA QUE LOS POLIGONOS SE QUEDARAN SIEMPRE EN GRIS----------------------------------//

          if (pol._selected) abrirPopupTrabajado(pol._id, {}, pol._territorioId);
        });

        pol.on('contextmenu', function (e) {
          mostrarMenu(e, pol, pol._notasPoligonos || {}, pol._territorioId);
        });
      });

      // Overlay gris sobre todo el mapa excepto el activo
      if (overlayGris) map.removeLayer(overlayGris);
      var mundo = [[90, -180], [90, 180], [-90, 180], [-90, -180], [90, -180]];
      var huecos = [];
      territorioActivo.eachLayer(pol => {
        if (pol.getLatLngs) huecos.push(pol.getLatLngs()[0].map(ll => [ll.lat, ll.lng]));
      });
      overlayGris = L.polygon([mundo, ...huecos], {
        color: "#000",
        fillColor: "#000",
        fillOpacity: 0.6,
        stroke: false,
        interactive: false
      }).addTo(map);

      // Mostrar etiquetas
      mostrarEtiquetas();

      // Mostrar indicadores de notas al final
      mostrarIndicadoresNotas();
    }






    // ================================
    // === Etiquetas ===
    // ================================
    function mostrarEtiquetas() {
      etiquetasActivas.forEach(m => map.removeLayer(m));
      etiquetasActivas = [];
      if (!territorioActivo) return;
      territorioActivo.eachLayer(function (pol) {
        if (pol._label) {
          let latlngs = pol.getLatLngs()[0];
          let coords = latlngs.map(ll => [ll.lng, ll.lat]);
          coords.push([coords[0][0], coords[0][1]]);
          let centroide = turf.centroid(turf.polygon([coords]));
          let cLat = centroide.geometry.coordinates[1];
          let cLng = centroide.geometry.coordinates[0];
          let marker = L.marker([cLat, cLng], {
            interactive: false,
            icon: L.divIcon({ className: "etiqueta-poligono", html: pol._label, iconSize: null, iconAnchor: [0, 0] })
          }).addTo(map);
          etiquetasActivas.push(marker);
        }
      });
    }





    // ================================
    // === Cambiar territorio desde select ===
    // ================================
    function cambiarTerritorio() {
      map.closePopup();
      var selector = document.getElementById("selectorTerritorios");
      var valor = selector.value;
      selector.blur();
      ocultarMenu();
      etiquetasActivas.forEach(m => map.removeLayer(m));
      etiquetasActivas = [];

      if (valor === "areaGrande") {
        selector.value = "";
        territorioActivo = null;
        flyWithLoader(boundsIniciales);
        return;
      }

      const match = valor.match(/^territorio(\d+)$/);
      if (match) {
        const num = match[1];
        const grupo = window["territorio" + num];
        if (grupo && grupo.getLayers().length > 0) {
          flyWithLoader(grupo.getBounds(), function () {
            enfocarTerritorio(grupo);
          });
        }
      }
    }






    // ================================
    // === Bot√≥n √Årea Grande ===
    // ================================
    document.getElementById("btnAreaGrande").addEventListener("click", function () {
      map.closePopup();
      document.getElementById("selectorTerritorios").value = ""; // limpiar select
      ocultarMenu();
      if (overlayGris) {
        map.removeLayer(overlayGris);
        overlayGris = null;
      }
      etiquetasActivas.forEach(m => map.removeLayer(m));
      etiquetasActivas = [];
      window.todosLosTerritorios.forEach(territorio => {
        territorio.eachLayer(pol => {
          pol._selected = false;
          pol.setStyle(pol._originalStyle);
        });
      });
      territorioActivo = null;
      flyWithLoader(boundsIniciales);
    });







    // ================================
    // === Inicializar todos los territorios autom√°ticamente ===
    // ================================
    const listaTerritorios = [
      datosTerritorio1, datosTerritorio2, datosTerritorio3, /* ... */ datosTerritorio84
    ];

    window.todosLosTerritorios = [];

    listaTerritorios.forEach(datosTerritorio => {
      const territorioData = crearTerritorio(datosTerritorio);
      const grupo = territorioData.grupo;
      window.todosLosTerritorios.push(grupo);

      const polFijo = datosTerritorio.poligonos[1] || datosTerritorio.poligonos[0];
      const centro = L.polygon(polFijo.coords).getBounds().getCenter();

      const marcador = L.marker(centro, {
        icon: L.divIcon({
          className: "etiquetaTerritorio",
          html: `<b>${datosTerritorio.numeroTerritorio}</b>`,
          iconSize: [20, 20]
        })
      }).addTo(map);

      grupo._marcadorTerritorio = marcador;
    });
  </script>






  <!-- Archivos externos de territorios -->

  <script src="dibujo.js"></script>

  <script src="area_grande.js"></script>
  <script src="territoriobase.js"></script>
  <script src="territorio1.js"></script>
  <script src="territorio2.js"></script>
  <script src="territorio3.js"></script>
  <script src="territorio4.js"></script>
  <script src="territorio5.js"></script>
  <script src="territorio6.js"></script>
  <script src="territorio7.js"></script>
  <script src="territorio8.js"></script>
  <script src="territorio9.js"></script>
  <script src="territorio10.js"></script>
  <script src="territorio11.js"></script>
  <script src="territorio12.js"></script>
  <script src="territorio13.js"></script>
  <script src="territorio14.js"></script>
  <script src="territorio15.js"></script>
  <script src="territorio16.js"></script>
  <script src="territorio17.js"></script>
  <script src="territorio18.js"></script>
  <script src="territorio19.js"></script>
  <script src="territorio20.js"></script>
  <script src="territorio21.js"></script>
  <script src="territorio22.js"></script>
  <script src="territorio23.js"></script>
  <script src="territorio24.js"></script>
  <script src="territorio25.js"></script>
  <script src="territorio26.js"></script>
  <script src="territorio27.js"></script>
  <script src="territorio28.js"></script>
  <script src="territorio29.js"></script>
  <script src="territorio30.js"></script>
  <script src="territorio31.js"></script>
  <script src="territorio32.js"></script>
  <script src="territorio33.js"></script>
  <script src="territorio34.js"></script>
  <script src="territorio35.js"></script>
  <script src="territorio36.js"></script>
  <script src="territorio37.js"></script>
  <script src="territorio38.js"></script>
  <script src="territorio39.js"></script>
  <script src="territorio40.js"></script>
  <script src="territorio41.js"></script>
  <script src="territorio42.js"></script>
  <script src="territorio43.js"></script>
  <script src="territorio44.js"></script>
  <script src="territorio45.js"></script>
  <script src="territorio46.js"></script>
  <script src="territorio47.js"></script>
  <script src="territorio48.js"></script>
  <script src="territorio49.js"></script>
  <script src="territorio50.js"></script>
  <script src="territorio51.js"></script>
  <script src="territorio52.js"></script>
  <script src="territorio53.js"></script>
  <script src="territorio54.js"></script>
  <script src="territorio55.js"></script>
  <script src="territorio56.js"></script>
  <script src="territorio57.js"></script>
  <script src="territorio58.js"></script>
  <script src="territorio59.js"></script>
  <script src="territorio60.js"></script>
  <script src="territorio61.js"></script>
  <script src="territorio62.js"></script>
  <script src="territorio63.js"></script>
  <script src="territorio64.js"></script>
  <script src="territorio65.js"></script>
  <script src="territorio66.js"></script>
  <script src="territorio67.js"></script>
  <script src="territorio68.js"></script>
  <script src="territorio69.js"></script>
  <script src="territorio70.js"></script>
  <script src="territorio71.js"></script>
  <script src="territorio72.js"></script>
  <script src="territorio73.js"></script>
  <script src="territorio74.js"></script>
  <script src="territorio75.js"></script>
  <script src="territorio76.js"></script>
  <script src="territorio77.js"></script>
  <script src="territorio78.js"></script>
  <script src="territorio79.js"></script>
  <script src="territorio80.js"></script>
  <script src="territorio81.js"></script>
  <script src="territorio82.js"></script>
  <script src="territorio83.js"></script>
  <script src="territorio84.js"></script>
  <script src="territorionegocios.js"></script>


</body>

</html>